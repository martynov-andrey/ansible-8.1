# Домашнее задание к занятию "08.01 Введение в Ansible"

## Подготовка к выполнению
1. Установите ansible версии 2.10 или выше.
2. Создайте свой собственный публичный репозиторий на github с произвольным именем.
3. Скачайте [playbook](./playbook/) из репозитория с домашним заданием и перенесите его в свой репозиторий.

### Ответы на задания.

1. Установленная в системе версия ansible 2.12.7.

```bash
    $ ansible --version | head -1
ansible [core 2.12.7]
```

2. Создан публичный репозиторий Github.

```bash
   $ git clone https://github.com/martynov-andrey/ansible-8.1.git
```

3. Playbook из задания добавлен в отдельный репозиторий.

```bash
     git push -u ssh-origin
Enumerating objects: 15, done.
Counting objects: 100% (15/15), done.
Delta compression using up to 4 threads
Compressing objects: 100% (8/8), done.
Writing objects: 100% (15/15), 1.61 KiB | 137.00 KiB/s, done.
Total 15 (delta 0), reused 0 (delta 0)
To github.com:martynov-andrey/ansible-8.1.git
 * [new branch]      master -> master
Branch 'master' set up to track remote branch 'master' from 'ssh-origin'.
```

## Основная часть
1. Попробуйте запустить playbook на окружении из `test.yml`, зафиксируйте какое значение имеет факт `some_fact` для указанного хоста при выполнении playbook'a.
2. Найдите файл с переменными (group_vars) в котором задаётся найденное в первом пункте значение и поменяйте его на 'all default fact'.
3. Воспользуйтесь подготовленным (используется `docker`) или создайте собственное окружение для проведения дальнейших испытаний.
4. Проведите запуск playbook на окружении из `prod.yml`. Зафиксируйте полученные значения `some_fact` для каждого из `managed host`.
5. Добавьте факты в `group_vars` каждой из групп хостов так, чтобы для `some_fact` получились следующие значения: для `deb` - 'deb default fact', для `el` - 'el default fact'.
6.  Повторите запуск playbook на окружении `prod.yml`. Убедитесь, что выдаются корректные значения для всех хостов.
7. При помощи `ansible-vault` зашифруйте факты в `group_vars/deb` и `group_vars/el` с паролем `netology`.
8. Запустите playbook на окружении `prod.yml`. При запуске `ansible` должен запросить у вас пароль. Убедитесь в работоспособности.
9. Посмотрите при помощи `ansible-doc` список плагинов для подключения. Выберите подходящий для работы на `control node`.
10. В `prod.yml` добавьте новую группу хостов с именем  `local`, в ней разместите localhost с необходимым типом подключения.
11. Запустите playbook на окружении `prod.yml`. При запуске `ansible` должен запросить у вас пароль. Убедитесь что факты `some_fact` для каждого из хостов определены из верных `group_vars`.

### Ответы на задания.

1. Факт `some_fact` имеет значение `12`.

```bash
    $ ansible-playbook -i ./inventory/test.yml site.yml 

PLAY [Print os facts] **************************************************************************************************************************************************************************************
TASK [Gathering Facts] *************************************************************************************************************************************************************************************ok: [localhost]

TASK [Print OS] ********************************************************************************************************************************************************************************************ok: [localhost] => {
    "msg": "Ubuntu"
}

TASK [Print fact] ******************************************************************************************************************************************************************************************ok: [localhost] => {
    "msg": 12
}

PLAY RECAP *************************************************************************************************************************************************************************************************localhost                  : ok=3    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0 
```

2. Назначение нового значения `some_fact`. 

```bash
    $ cat group_vars/all/examp.yml 
---
  some_fact: 'all default fact'
    
    $ ansible-playbook -i ./inventory/test.yml site.yml

PLAY [Print os facts] **************************************************************************************************************************************************************************************
TASK [Gathering Facts] *************************************************************************************************************************************************************************************ok: [localhost]

TASK [Print OS] ********************************************************************************************************************************************************************************************ok: [localhost] => {
    "msg": "Ubuntu"
}

TASK [Print fact] ******************************************************************************************************************************************************************************************ok: [localhost] => {
    "msg": "all default fact"
}

PLAY RECAP *************************************************************************************************************************************************************************************************localhost                  : ok=3    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
```

3. Запуск окружения.

```bash
    $ sudo docker run --rm --name "ubuntu" -d pycontribs/ubuntu:latest sleep 3600
cab6baaab4b9322802f618ad3d10cbfccebb336886f478425520fd94e81aa922
    $ sudo docker run --rm --name "centos7" -d pycontribs/centos:7 sleep 3600
cdfa306c478146d0023def9681ac02e5547685a282881d1da3ce31695958522b
    $ sudo docker ps
CONTAINER ID   IMAGE                      COMMAND        CREATED              STATUS              PORTS     NAMES
cdfa306c4781   pycontribs/centos:7        "sleep 3600"   40 seconds ago       Up 38 seconds                 centos7
cab6baaab4b9   pycontribs/ubuntu:latest   "sleep 3600"   About a minute ago   Up About a minute             ubuntu
```

4. Запуск playbook на окружении `prod.yml`. 

```bash
    $ sudo ansible-playbook -i ./inventory/prod.yml site.yml 

PLAY [Print os facts] *************************************************************************************************************************************************************************************************************************

TASK [Gathering Facts] ************************************************************************************************************************************************************************************************************************
ok: [ubuntu]
ok: [centos7]

TASK [Print OS] *******************************************************************************************************************************************************************************************************************************
ok: [centos7] => {
    "msg": "CentOS"
}
ok: [ubuntu] => {
    "msg": "Ubuntu"
}

TASK [Print fact] *****************************************************************************************************************************************************************************************************************************
ok: [centos7] => {
    "msg": "el"
}
ok: [ubuntu] => {
    "msg": "deb"
}

PLAY RECAP ************************************************************************************************************************************************************************************************************************************
centos7                    : ok=3    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   
ubuntu                     : ok=3    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
```

* Значение `some_fact` для `managed host` "ubuntu" `deb`.
* Значение `some_fact` для `managed host` "centos7" `el`.

5. Новые факты в `group_vars` для групп хостов.

```bash
   $ cat group_vars/deb/examp.yml 
---
  some_fact: "deb default fact"
   $ cat group_vars/el/examp.yml 
---
  some_fact: "el default fact"
```

6. Повторный запуск playbook на окружении `prod.yml`.

```bash
    $ sudo ansible-playbook -i ./inventory/prod.yml site.yml 

PLAY [Print os facts] *************************************************************************************************************************************************************************************************************************

TASK [Gathering Facts] ************************************************************************************************************************************************************************************************************************
ok: [ubuntu]
ok: [centos7]

TASK [Print OS] *******************************************************************************************************************************************************************************************************************************
ok: [centos7] => {
    "msg": "CentOS"
}
ok: [ubuntu] => {
    "msg": "Ubuntu"
}

TASK [Print fact] *****************************************************************************************************************************************************************************************************************************
ok: [centos7] => {
    "msg": "el default fact"
}
ok: [ubuntu] => {
    "msg": "deb default fact"
}

PLAY RECAP ************************************************************************************************************************************************************************************************************************************
centos7                    : ok=3    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   
ubuntu                     : ok=3    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0 
```
* Значение `some_fact` для `managed host` "ubuntu" `deb default fact`.
* Значение `some_fact` для `managed host` "centos7" `el default fact`.

7. Шифрование фактов с помощью `ansible-vault`.

```bash
    $ ansible-vault encrypt group_vars/deb/examp.yml 
New Vault password: 
Confirm New Vault password: 
Encryption successful
    $ ansible-vault encrypt group_vars/el/examp.yml 
New Vault password: 
Confirm New Vault password: 
Encryption successful
    $ cat group_vars/deb/examp.yml
$ANSIBLE_VAULT;1.1;AES256
63386662393931313533613465353966666461363665626230653761633038333637396265363439
6632613463306566383063656264316261623938373664630a366363613631316131313162303536
32656461393138333437333434343736326631326430326134366362663765613161326563643362
3165303030353761310a363062393238623562613034303436386165336463623961323937626562
33306232376461393462393533356332636138366333333961386238393934653434366365393939
3231313762646239373435336134326364633835653261646565
    $ cat group_vars/el/examp.yml 
$ANSIBLE_VAULT;1.1;AES256
61393162633933333962643764373063323965663563313432633033643739613630383866323532
3632383133376664643333313564303435313762376635340a306132316561326165316561363364
66383339393138373034666532346539376539636432636163663165643163616464393230346262
6538313633366131360a646336383032653961633230623239303765613836323036323134336639
61353335653631393935353736613037346233396464346566656331326237626435376437353233
6435343965323336616536623630656239336362326162343237
```

8. Запуск playbook с окружением `prod.yml` и ключом `--ask-vault-pass` для запроса пароля шифрования.

```bash
    $ sudo ansible-playbook -i ./inventory/prod.yml site.yml --ask-vault-password
Vault password: 

PLAY [Print os facts] *************************************************************************************************************************************************************************************************************************

TASK [Gathering Facts] ************************************************************************************************************************************************************************************************************************
ok: [ubuntu]
ok: [centos7]

TASK [Print OS] *******************************************************************************************************************************************************************************************************************************
ok: [centos7] => {
    "msg": "CentOS"
}
ok: [ubuntu] => {
    "msg": "Ubuntu"
}

TASK [Print fact] *****************************************************************************************************************************************************************************************************************************
ok: [centos7] => {
    "msg": "el default fact"
}
ok: [ubuntu] => {
    "msg": "deb default fact"
}

PLAY RECAP ************************************************************************************************************************************************************************************************************************************
centos7                    : ok=3    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   
ubuntu                     : ok=3    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
```

9. Для подключения к `control node` выбран плагин `local`. 

```bash
    $ ansible-doc -t connection --list | grep "on control"

local                          execute on controller
```

10. Новая группа хостов с именем `local` в `prod.yml`. 

```bash
    $ cat inventory/prod.yml 
---
  el:
    hosts:
      centos7:
        ansible_connection: docker
  deb:
    hosts:
      ubuntu:
        ansible_connection: docker
  local:
    hosts:
      localhost:
        ansible_connection: local    
```

11. Запуск playbook на окружении `prod.yml`. 

```bash
    $ sudo ansible-playbook -i ./inventory/prod.yml site.yml --ask-vault-passwor
Vault password: 

PLAY [Print os facts] *************************************************************************************************************************************************************************************************************************

TASK [Gathering Facts] ************************************************************************************************************************************************************************************************************************
ok: [ubuntu]
ok: [localhost]
ok: [centos7]

TASK [Print OS] *******************************************************************************************************************************************************************************************************************************
ok: [centos7] => {
    "msg": "CentOS"
}
ok: [ubuntu] => {
    "msg": "Ubuntu"
}
ok: [localhost] => {
    "msg": "Ubuntu"
}

TASK [Print fact] *****************************************************************************************************************************************************************************************************************************
ok: [centos7] => {
    "msg": "el default fact"
}
ok: [ubuntu] => {
    "msg": "deb default fact"
}
ok: [localhost] => {
    "msg": "all default fact"
}

PLAY RECAP ************************************************************************************************************************************************************************************************************************************
centos7                    : ok=3    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   
localhost                  : ok=3    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   
ubuntu                     : ok=3    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
```

* Значение `some_fact` для `managed host` "ubuntu" `deb default fact`.
* Значение `some_fact` для `managed host` "centos7" `el default fact`.
* Значение `some_fact` для `managed host` "localhost" `all default fact`.